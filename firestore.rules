rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user data
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Helper function to get user role safely
    function getUserRole() {
      return getUserData().role;
    }
    
    // Helper function to check if user is superAdmin (case-insensitive check)
    function isSuperAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             getUserRole() != null &&
             (getUserRole() == 'superAdmin' || 
              getUserRole() == 'SuperAdmin' || 
              getUserRole() == 'SUPERADMIN' ||
              getUserRole() == 'superadmin');
    }
    
    // Helper function to check if user is admin (includes superAdmin)
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             getUserRole() != null &&
             (getUserRole() == 'admin' || 
              getUserRole() == 'superAdmin' || 
              getUserRole() == 'SuperAdmin' || 
              getUserRole() == 'SUPERADMIN' ||
              getUserRole() == 'superadmin');
    }
    
    // Helper function to check if user is organization admin
    function isOrganizationAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             getUserRole() != null &&
             getUserRole() == 'admin';
    }
    
    // Helper function to check if user is teacher
    function isTeacher() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             getUserRole() != null &&
             getUserRole() == 'teacher';
    }
    
    // Helper function to get user's organizationId
    function getUserOrganizationId() {
      return getUserData().organizationId;
    }
    
    // Helper function to get user's name
    function getUserName() {
      return getUserData().name;
    }
    
    // Helper function to check if document belongs to user's organization
    function belongsToUserOrganization() {
      return resource.data.organizationId == getUserOrganizationId();
    }
    
    // Helper function to check if user is the owner of a document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Organizations collection
    match /organizations/{orgId} {
      // SuperAdmin can read and write all organizations
      allow read, write: if isSuperAdmin();
      
      // Organization admins can read their own organization
      // Allow read if the document's id field matches user's organizationId OR if orgId matches
      allow read: if isOrganizationAdmin() && 
                     (resource.data.id == getUserOrganizationId() || 
                      orgId == getUserOrganizationId());
      
      // Organization admins can update their own organization
      allow update: if isOrganizationAdmin() && 
                      (resource.data.id == getUserOrganizationId() || 
                       orgId == getUserOrganizationId()) &&
                      (request.resource.data.id == getUserOrganizationId() || 
                       orgId == getUserOrganizationId());
      
      // Organization admins can create organizations (if needed)
      allow create: if isOrganizationAdmin() && 
                      request.resource.data.id == getUserOrganizationId();
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read and write their own document
      allow read, write: if isOwner(userId);
      
      // SuperAdmin can read and write all user documents
      allow read, write: if isSuperAdmin();
      
      // Organization admins can read and write users in their organization
      allow read, write: if isOrganizationAdmin() && 
                            (resource.data.organizationId == getUserOrganizationId() || 
                             request.resource.data.organizationId == getUserOrganizationId());
      
      // Teachers can read only students enrolled in their assigned classes
      // Allow list queries: teachers can query students by role and organizationId
      // The actual filtering by class enrollment is done client-side
      // For list queries, Firestore requires the query to filter on the same fields the rule checks
      allow read: if isTeacher() && 
                     resource.data.organizationId == getUserOrganizationId() &&
                     (resource.data.role == 'student' || resource.data.role == 'Student' || resource.data.role == 'STUDENT');
      
      // Teachers cannot create students - removed create permission
      
      // Teachers cannot update students - removed update permission
    }
    
    // Recordings collection
    match /recordings/{recordingId} {
      // Users can read recordings in their organization
      allow read: if isAuthenticated() && 
                     (resource.data.organizationId == getUserOrganizationId() || isSuperAdmin());
      
      // SuperAdmin can write all recordings
      allow write: if isSuperAdmin();
      
      // Organization admins can write recordings in their organization
      allow write: if isOrganizationAdmin() && 
                      (resource.data.organizationId == getUserOrganizationId() || 
                       request.resource.data.organizationId == getUserOrganizationId());
      
      // Teachers can read and write recordings in their organization
      allow read: if isTeacher() && 
                     resource.data.organizationId == getUserOrganizationId();
      allow write: if isTeacher() && 
                      request.resource.data.organizationId == getUserOrganizationId();
    }
    
    // Tasks collection
    match /tasks/{taskId} {
      // Users can read their own tasks
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // SuperAdmin can read and write all tasks
      allow read, write: if isSuperAdmin();
      
      // Organization admins can read and write tasks in their organization
      allow read, write: if isOrganizationAdmin() && 
                           (resource.data.organizationId == getUserOrganizationId() || 
                            request.resource.data.organizationId == getUserOrganizationId());
      
      // Users can create tasks assigned to themselves
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      // Users can update their own tasks
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
    
    // Blog Posts collection
    match /blogPosts/{postId} {
      // Users can read published posts in their organization
      allow read: if isAuthenticated() && 
                     (resource.data.status == 'published' || isSuperAdmin() || 
                      (isOrganizationAdmin() && resource.data.organizationId == getUserOrganizationId()));
      
      // SuperAdmin can write all blog posts
      allow write: if isSuperAdmin();
      
      // Organization admins can write blog posts in their organization
      allow write: if isOrganizationAdmin() && 
                      (resource.data.organizationId == getUserOrganizationId() || 
                       request.resource.data.organizationId == getUserOrganizationId());
    }
    
    // Zoom Sessions collection
    match /zoomSessions/{sessionId} {
      // Users can read sessions in their organization
      allow read: if isAuthenticated() && 
                     (resource.data.organizationId == getUserOrganizationId() || isSuperAdmin());
      
      // SuperAdmin can write all sessions
      allow write: if isSuperAdmin();
      
      // Organization admins can write sessions in their organization
      allow write: if isOrganizationAdmin() && 
                      (resource.data.organizationId == getUserOrganizationId() || 
                       request.resource.data.organizationId == getUserOrganizationId());
    }
    
    // Courses collection
    match /courses/{courseId} {
      // SuperAdmin can read and write all courses
      allow read, write: if isSuperAdmin();
      
      // Organization admins can read courses in their organization (including those without organizationId for backward compatibility)
      allow read: if isOrganizationAdmin() && 
                     (resource.data.organizationId == getUserOrganizationId() || 
                      !resource.data.organizationId);
      
      // Organization admins can create courses in their organization
      allow create: if isOrganizationAdmin() && 
                      request.resource.data.organizationId != null &&
                      request.resource.data.organizationId == getUserOrganizationId();
      
      // Organization admins can update courses in their organization
      allow update: if isOrganizationAdmin() && 
                      (resource.data.organizationId == getUserOrganizationId() || 
                       !resource.data.organizationId) &&
                      request.resource.data.organizationId == getUserOrganizationId();
      
      // Organization admins can delete courses in their organization
      allow delete: if isOrganizationAdmin() && 
                      resource.data.organizationId == getUserOrganizationId();
      
      // Teachers can read courses in their organization
      // For list queries, we allow reading by organizationId, then filter client-side
      // The client-side filtering ensures only courses where instructor matches, createdBy matches, or assignedTeachers includes the teacher
      allow read: if isTeacher() && 
                     resource.data.organizationId == getUserOrganizationId();
      
      // Teachers can create courses in their organization (with createdBy set to their UID)
      allow create: if isTeacher() && 
                       request.resource.data.organizationId != null &&
                       request.resource.data.organizationId == getUserOrganizationId() &&
                       request.resource.data.createdBy == request.auth.uid;
      
      // Teachers can update and delete courses where instructor name matches their name or they created it
      // BUT teachers cannot change the instructor field - only admins can change it
      allow update, delete: if isTeacher() && 
                               resource.data.organizationId == getUserOrganizationId() &&
                               (resource.data.instructor == getUserName() ||
                                resource.data.createdBy == request.auth.uid) &&
                               // Prevent teachers from changing the instructor field
                               (request.resource.data.instructor == resource.data.instructor);
    }
    
    // Batches collection
    match /batches/{batchId} {
      // Users can read batches in their organization
      allow read: if isAuthenticated() && 
                     (resource.data.organizationId == getUserOrganizationId() || isSuperAdmin());
      
      // SuperAdmin can write all batches
      allow write: if isSuperAdmin();
      
      // Organization admins can write batches in their organization
      allow write: if isOrganizationAdmin() && 
                      (resource.data.organizationId == getUserOrganizationId() || 
                       request.resource.data.organizationId == getUserOrganizationId());
    }
    
    // Payments collection
    match /payments/{paymentId} {
      // Users can read their own payments
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // SuperAdmin can read and write all payments
      allow read, write: if isSuperAdmin();
      
      // Organization admins can read and write payments in their organization
      allow read, write: if isOrganizationAdmin() && 
                            (resource.data.organizationId == getUserOrganizationId() || 
                             request.resource.data.organizationId == getUserOrganizationId());
      
      // Users can create payments for themselves
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
    }
    
    // Payroll collection
    match /payroll/{payrollId} {
      // SuperAdmin can read and write all payroll
      allow read, write: if isSuperAdmin();
      
      // Organization admins can read payroll in their organization
      // For list queries, allow reading if organizationId matches
      allow read: if isOrganizationAdmin() && 
                     (resource.data.organizationId == getUserOrganizationId() || 
                      !exists(resource.data.organizationId));
      
      // Organization admins can create payroll in their organization
      allow create: if isOrganizationAdmin() && 
                      request.resource.data.organizationId == getUserOrganizationId();
      
      // Organization admins can update payroll in their organization
      allow update: if isOrganizationAdmin() && 
                      resource.data.organizationId == getUserOrganizationId() &&
                      request.resource.data.organizationId == getUserOrganizationId();
      
      // Organization admins can delete payroll in their organization
      allow delete: if isOrganizationAdmin() && 
                      resource.data.organizationId == getUserOrganizationId();
      
      // Employees (teachers/admins) can read their own payroll records
      allow read: if isAuthenticated() && 
                     resource.data.employeeId == request.auth.uid;
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
